height_info:
  binding:
    files:
      - legged_gym/legged_gym/envs/base/humanoid_robot.py
      - challenging_terrain/terrain_base/config.py
      - legged_gym/legged_gym/envs/base/legged_robot_config.py
    toggles_and_dims:
      measure_heights: cfg.terrain.measure_heights  # True/False
      n_scan: 132  # 12 (x) × 11 (y)
      clip_range: [-1, 1]  # 高度差裁剪范围
      update_interval: cfg.depth.update_interval  # 高度更新步频（按全局计数）
  acquisition:
    init_points:
      fn: _init_height_points
      file: legged_gym/legged_gym/envs/base/humanoid_robot.py
      grid:
        measured_points_x: challenging_terrain/terrain_base/config.py::measured_points_x  # 12 个
        measured_points_y: challenging_terrain/terrain_base/config.py::measured_points_y  # 11 个
        num_height_points: 132  # meshgrid(x,y).numel()
      with_noise:
        measure_horizontal_noise: cfg.terrain.measure_horizontal_noise
      also_prepare_dataset_points:
        dataset_points_x: challenging_terrain/terrain_base/config.py::dataset_points_x
        dataset_points_y: challenging_terrain/terrain_base/config.py::dataset_points_y
        use: 数据集记录可视化（policy不使用）
    sampling_runtime:
      trigger:
        conds:
          - cfg.terrain.measure_heights == True
          - global_counter % cfg.depth.update_interval == 0
      fn: _get_heights
      pose_transform:
        - 将高度采样点在 base yaw 框架下旋转: quat_apply_yaw(base_quat, height_points)
        - 再平移到世界坐标: + root_states[:, :3]
      terrain_indexing:
        - 加上 border_size
        - 除以 horizontal_scale 并转为 long 索引
      outputs:
        - measured_heights: (num_envs, 132)
        - measured_heights_data: (num_envs, num_height_points_data)  # 记录/可视化用
  usage:
    observation_integration:
      where: compute_observations
      file: legged_gym/legged_gym/envs/base/humanoid_robot.py
      step:
        - heights = clip(root_z - 0.3 - measured_heights, -1, 1)
        - obs_buf = concat(obs_core, heights, priv_explicit, priv_latent, obs_history_flat)
      details:
        obs_toggle: 仅当 cfg.terrain.measure_heights == True 才拼接 heights
        n_scan: 132  # 直接拼入 observation 的扫描段长度
        clip_obs: cfg.normalization.clip_observations（对最终 obs_buf 与 privileged_obs 裁剪）
    reward_usage:
      base_height_reward:
        where: _reward_base_height
        file: legged_gym/legged_gym/envs/base/humanoid_robot.py
        formula:
          base_height := mean(root_states[:,2] - measured_heights)
          penalty := (base_height - cfg.rewards.base_height_target)^2
        note: measured_heights 提供地形参考，让机体高度评估相对地面而非绝对 z
    logging_and_visualization:
      episode_record:
        buffers:
          - current_episode_buffer['height_map'] ← measured_heights_data  # 每步追加
          - episode_data['height_map'] ← 按回合聚合后保存
      viewer_draw:
        fn: _draw_debug_vis
        draw: 使用 measured_heights 与 height_points（或 *_data 版本）在 viewer 中标注
  configs:
    sources:
      - challenging_terrain/terrain_base/config.py
      - legged_gym/legged_gym/envs/base/legged_robot_config.py
    keys:
      - terrain.measure_heights: True  # 启用高度采样
      - terrain.measured_points_x: [-0.45, -0.3, ..., 1.2]  # 12
      - terrain.measured_points_y: [-0.75, -0.6, ..., 0.75] # 11
      - terrain.measure_horizontal_noise: 0.0
      - depth.update_interval: <int>  # 采样频率
      - rewards.base_height_target: <float>  # 基座目标高度
    derived:
      - n_scan = len(measured_points_x) * len(measured_points_y) = 12 * 11 = 132
  notes:
    - measured_heights 是相对地形的高度样本，拼入 obs 作为 n_scan 段，增强对地形的可感知性。
    - base_height reward 使用 measured_heights 使高度偏离度量具备地面参考，避免仅用绝对 z。
    - 若关闭 measure_heights，则不采样、不拼接 heights，但 n_scan 维度设计在配置中保留为固定值。
  workflow:
    modify_heights:
      steps:
        - step: 第一步
          desc: 在 challenging_terrain/terrain_base/config.py 改采样网格（点数/范围）
          file: challenging_terrain/terrain_base/config.py
          keys:
            - terrain_config.measured_points_x
            - terrain_config.measured_points_y
            - terrain_config.dataset_points_x  # 仅记录/可视化
            - terrain_config.dataset_points_y  # 仅记录/可视化
          notes:
            - 改变点数会改变 n_scan = len(x)*len(y)，需与 cfg.env.n_scan 保持一致
            - 如需要加入扰动，见 measure_horizontal_noise（同文件）
        - step: 第二步
          desc: 调整相关开关/频率/目标高度
          files:
            - challenging_terrain/terrain_base/config.py  # measure_heights, measure_horizontal_noise
            - legged_gym/legged_gym/envs/base/legged_robot_config.py  # update_interval, base_height_target
          keys:
            - terrain_config.measure_heights  # 开关（地形配置）
            - terrain_config.measure_horizontal_noise  # 采样点水平扰动（地形配置）
            - LeggedRobotCfg.depth.update_interval  # 高度更新步频（机器人配置）
            - LeggedRobotCfg.rewards.base_height_target  # 基座目标高度（机器人配置）
        - step: 第三步
          desc: 调整观测拼接/裁剪与奖励；必要时改采样与索引
          file: legged_gym/legged_gym/envs/base/humanoid_robot.py
          where:
            - compute_observations  # heights 裁剪、与 obs 的拼接
            - _reward_base_height  # 使用 measured_heights 的奖励
            - _init_height_points  # 采样点生成（含水平噪声）
            - _get_heights  # 位姿变换与地形索引
          notes:
            - heights 默认裁剪到 [-1, 1]，可按需求放宽或标准化后再裁剪
            - 如改了网格点数，确保 cfg.env.n_scan 与网络输入一致
        - step: 第四步
          desc: 运行验证与可视化
          scripts:
            - legged_gym/legged_gym/scripts/play.py  # 快速交互查看
            - legged_gym/legged_gym/scripts/evaluate.py  # 评估表现
          observe:
            - logs 下 episode 记录中的 height_map 与 viewer 可视化是否匹配期望
